<head>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>

    <script src="./js/globe.gl.min.js"></script>
</head>

<body>
    <div id="globeViz"></div>
    <button
        style="position: absolute; bottom: 0; right: 0"
        onclick="nextHandler(getRandomExcept(0, 7, 2))"
    >
        Next
    </button>
    <button style="position: absolute; bottom: 0; right: 50" onclick="LondonHandler()">
        London
    </button>

    <script>
        const geojson = {
            type: "FeatureCollection",
            features: [
                {
                    type: "Feature",
                    properties: {
                        name: "New York",
                        latitude: 40.712776,
                        longitude: -74.005974,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "Tokyo",
                        latitude: 35.682839,
                        longitude: 139.759455,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "London",
                        latitude: 51.50853,
                        longitude: -0.12574,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "Sydney",
                        latitude: -33.86682,
                        longitude: 151.209295,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "Cairo",
                        latitude: 30.04996,
                        longitude: 31.24997,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "Rio de Janeiro",
                        latitude: -22.923077,
                        longitude: -43.226967,
                    },
                },
                {
                    type: "Feature",
                    properties: {
                        name: "Moscow",
                        latitude: 55.755786,
                        longitude: 37.617636,
                    },
                },
            ],
        };

        let lastRnd = -1;

        function getRandom(lower, upper) {
            let rnd = Math.floor(Math.random() * (upper - lower) + lower);
            while (lastRnd == rnd) {
                rnd = Math.floor(Math.random() * (upper - lower) + lower);
            }
            lastRnd = rnd;
            return rnd;
        }

        function getRandomCity() {
            return geojson.features[getRandom(0, geojson.features.length)];
        }

        function getRandomExcept(lower, upper, indexExcept) {
            let rnd = Math.floor(Math.random() * (upper - lower) + lower);
            while (lastRnd == rnd || rnd == indexExcept) {
                rnd = Math.floor(Math.random() * (upper - lower) + lower);
            }
            lastRnd = rnd;
            return rnd;
        }

        const N = 15;
        const arcsData = [];

        for (let i = 0; i < N; i++) {
            const startCity = getRandomCity();
            let endCity = getRandomCity();

            while (endCity === startCity) {
                endCity = getRandomCity();
            }

            arcsData.push({
                startLat: startCity.properties.latitude,
                startLng: startCity.properties.longitude,
                endLat: endCity.properties.latitude,
                endLng: endCity.properties.longitude,
                color: [
                    ["red", "white", "blue", "green"][Math.round(Math.random() * 3)],
                    ["red", "white", "blue", "green"][Math.round(Math.random() * 3)],
                ],
            });
        }

        let places;
        let g;

        fetch("./data/ne_110m_populated_places_simple.geojson")
            .then((res) => res.json())
            .then((data) => {
                places = data;

                g = Globe()
                    .globeImageUrl("./img/earth-day.jpg")
                    .backgroundImageUrl("./img/night-sky.png")
                    .labelsData(places.features)
                    .labelLat((d) => d.properties.latitude)
                    .labelLng((d) => d.properties.longitude)
                    .labelText((d) => d.properties.name)
                    .labelSize((d) => Math.sqrt(d.properties.pop_max) * 4e-4)
                    .labelDotRadius((d) => Math.sqrt(d.properties.pop_max) * 4e-4)
                    .labelColor(() => "#420400")
                    .labelResolution(2)
                    .arcsData(arcsData)
                    .arcColor("color")
                    .arcDashLength(() => Math.random())
                    .arcDashGap(() => Math.random())
                    .arcStroke(0.8)
                    .arcDashAnimateTime(() => Math.random() * 4000 + 500)(
                    document.getElementById("globeViz")
                );

                const city = geojson.features[2];
                const lat = city.properties.latitude;
                const lon = city.properties.longitude;

                g.pointOfView({ lat, lng: lon, altitude: 2 }, 1000);
            });

        function nextHandler(cityIndex) {
            cityIndex = Math.floor(cityIndex);
            if (cityIndex >= 0 && cityIndex < geojson.features.length) {
                const city = geojson.features[cityIndex];
                const lat = city.properties.latitude;
                const lon = city.properties.longitude;

                g.pointOfView({ lat, lng: lon, altitude: 2 }, 1000);
            }
        }

        function LondonHandler() {
            nextHandler(2);
        }
    </script>
</body>
